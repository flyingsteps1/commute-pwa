import { createContext, useContext, useMemo, useState, type ReactNode } from "react";
import { STRINGS, type Lang, type LangKey } from "./strings";

const LANG_STORAGE_KEY = "app_lang";

function normalizeLang(value: string | null): Lang {
  return value === "ja" ? "ja" : "ko";
}

type I18nValue = {
  lang: Lang;
  setLang: (lang: Lang) => void;
  toggleLang: () => void;
  t: (key: LangKey | string) => string;
};

export const I18nContext = createContext<I18nValue>({
  lang: "ko",
  setLang: () => {},
  toggleLang: () => {},
  t: (key) => String(key),
});

export function I18nProvider({ children }: { children: ReactNode }) {
  const [lang, setLangState] = useState<Lang>(() => normalizeLang(localStorage.getItem(LANG_STORAGE_KEY)));

  const EXTRA = useMemo(
    () => ({
      ko: {
        app_title: "ORCLE TOUR",
        app_desc: "출퇴근 기록 앱",
        version: "버전 1.0.0",
        login_admin: "관리자",
        login_staff: "ORCLE TOUR 직원",
        login_staff_select_label: "직원 선택",
        login_staff_select_placeholder: "직원을 선택하세요",
        login_password_label: "비밀번호",
        login_password_placeholder: "비밀번호를 입력하세요",
        login_button: "로그인",
        login_forgot_password: "비밀번호를 잊으셨나요?",
        records_title: "기록",
        records_prev_month: "이전 달",
        records_next_month: "다음 달",
        records_stat_days: "근무일수",
        records_stat_total: "총근무",
        records_stat_avg: "평균",
        records_empty: "기록이 없습니다.",
        records_th_date: "날짜",
        records_th_inout: "출/퇴근",
        records_th_break: "휴게",
        records_th_work: "근무",
        records_btn_save: "저장",
        records_btn_cancel: "취소",
        records_aria_edit: "수정",
        today_title: "오늘",
        today_desc_default: "오늘의 근무 시간을 기록하세요.",
        today_desc_editing: "선택한 날짜를 수정 중입니다.",
        today_go_today: "오늘로",
        today_label_check_in: "출근",
        today_label_check_out: "퇴근",
        today_label_break: "휴게시간",
        today_unit_minutes: "단위: 분",
        today_btn_now: "지금",
        today_btn_save: "저장하기",
        today_saved: "저장됨",
        today_data_options: "데이터 옵션",
        today_backup: "백업",
        today_restore: "복원",
        today_clear_all: "전체 삭제",
        today_backup_json: "백업 JSON",
        today_restore_json: "복원 JSON",
        today_backup_placeholder: "백업 버튼을 누르면 여기에 JSON이 생성됩니다.",
        today_restore_placeholder: '예: [{"date":"2025-12-19","checkIn":"09:00","checkOut":"18:00","breakMin":60}]',
        today_restore_note: "복원 버튼을 누르면 위 JSON으로 데이터가 덮어써집니다.",
        today_alert_restore_fail: "복원 실패",
        today_alert_clear_done: "삭제 완료",
        calendar_title: "달력",
        calendar_prev_month: "이전 달",
        calendar_next_month: "다음 달",
        calendar_status_none: "기록 없음",
        calendar_sheet_edit: "수정하기",
        calendar_sheet_close: "닫기",
        calendar: "달력",
        admin_dashboard_title: "직원 근무 현황",
        admin_dashboard_subtitle_today: "오늘의 상태",
        admin_dashboard_staff_list: "직원 목록",
        admin_monthly_title: "월별",
        admin_monthly_desc: "직원별 월간 요약",
        admin_monthly_prev_month: "이전 달",
        admin_monthly_next_month: "다음 달",
        admin_monthly_staff_list: "직원 목록",
        admin_monthly_th_staff: "직원",
        admin_monthly_th_days: "근무일",
        admin_monthly_th_total: "총근무",
        admin_monthly_th_incomplete: "미완료",
        admin_monthly_empty_staff: "직원이 없습니다.",
        admin_staff_detail_title: "직원 상세",
        admin_staff_detail_prev_month: "이전 달",
        admin_staff_detail_next_month: "다음 달",
        admin_staff_detail_summary_total_work: "총 근무시간",
        admin_staff_detail_summary_days: "근무일수",
        admin_staff_detail_summary_incomplete: "미완료",
        admin_staff_detail_empty: "기록이 없습니다.",
        admin_staff_detail_th_date: "날짜",
        admin_staff_detail_th_check_in: "출근",
        admin_staff_detail_th_check_out: "퇴근",
        admin_staff_detail_th_break: "휴게",
        admin_staff_detail_th_work: "근무",
        settings_title: "설정",
        settings_desc: "직원 관리 및 보안",
        settings_staff_list: "직원 목록",
        settings_add_staff: "직원 추가",
        settings_staff_id: "직원 ID",
        settings_staff_name: "직원 이름",
        settings_staff_password_init: "초기 비밀번호",
        settings_change_staff_password: "비밀번호 변경",
        settings_admin_password_change: "관리자 비밀번호 변경",
        settings_admin_password_current: "현재 비밀번호",
        settings_admin_password_new: "새 비밀번호",
        settings_admin_password_submit: "변경하기",
        settings_alert_password_changed: "비밀번호가 변경되었습니다",
        settings_error_name_required: "직원 이름을 입력해주세요",
        settings_error_id_required: "직원 ID를 입력해주세요",
        settings_error_pw_required: "비밀번호를 입력해주세요",
        settings_error_admin_pw_required: "현재 비밀번호와 새 비밀번호를 모두 입력해주세요",
        settings_error_admin_pw_wrong: "현재 비밀번호가 올바르지 않습니다",
        settings_error_auth_required: "관리자 로그인 후 다시 시도해주세요",
        settings_error_session_expired: "세션이 오래됐습니다. 다시 로그인해주세요.",
        settings_staff_added: "직원이 추가되었습니다",
        settings_staff_deleted_banned: "근무기록이 있어 계정은 삭제되지 않았지만 로그인은 차단되었습니다.",
        settings_staff_pw_changed: "비밀번호가 변경되었습니다",
        settings_staff_create_failed: "직원 생성에 실패했습니다",
        settings_staff_update_failed: "직원 정보 변경에 실패했습니다",
        settings_staff_limit: "직원은 최대 5명까지 추가할 수 있습니다.",
        settings_staff_limit_reached: "직원은 최대 5명까지 추가할 수 있습니다.",
        settings_admin_only: "관리자 전용",
        settings_delete: "삭제",
        settings_confirm_delete_staff: "이 직원을 삭제할까요?",
        settings_back: "뒤로",
        staff_monthly_title: "월요약",
        staff_monthly_total_work: "총 근무시간",
        staff_monthly_total_break: "총 휴게시간",
        staff_monthly_days: "근무일 수",
        staff_monthly_incomplete: "미완료",
        staff_monthly_incomplete_hint: "(출/퇴 누락)",
        staff_monthly_holiday: "총 휴무",
        staff_monthly_pdf: "PDF 출력",
        staff_monthly_warn_title: "기록 정리가 필요해요",
        staff_monthly_warn_sub: "미완료된 근무 기록이 {count}건 있습니다.",
        today_sum_work: "총 근무시간",
        today_sum_break: "휴게시간",
        common_working: "근무중",
        common_break: "휴식중",
        common_off: "퇴근",
        common_no_record: "기록없음",
        common_incomplete: "미완료",
        common_check_in: "출근",
        common_check_out: "퇴근",
        common_break_start: "휴식 시작",
        common_holiday: "휴무",
        common_holiday_cancel: "휴무 취소",
        common_save: "저장하기",
        common_cancel: "취소",
        common_dash: "—",
        common_loading: "로딩 중...",
        common_staff: "직원",
        print_incomplete: "미완료",
        print_holiday: "휴무",
        print_holiday_days: "휴무",
        print_work: "근무",
        print_break: "휴게",
        print_overtime: "연장",
        print_early_leave: "조퇴",
        print_date: "날짜",
        print_check_in: "출근",
        print_check_out: "퇴근",
        print_total_work: "총 근무시간",
        print_total_break: "총 휴게시간",
        print_workdays: "근무일수",
        print_title: "출퇴근 기록표",
        print_monthly_title: "월별 기록표",
        print_button: "인쇄 / PDF 출력",
        print_no_info: "정보가 없습니다",
        print_invalid_month: "month=YYYY-MM 형식으로 입력하세요",
        print_loading: "Loading...",
        records_filter_all: "전체",
        records_filter_work: "근무",
        records_filter_incomplete: "미완료",
        records_filter_holiday: "휴무",
        records_stat_holiday: "총 휴무",
        print_status_working: "근무중",
      },
      ja: {
        app_title: "ORCLE TOUR",
        app_desc: "出退勤記録アプリ",
        version: "バージョン 1.0.0",
        login_admin: "管理者",
        login_staff: "ORCLE TOUR スタッフ",
        login_staff_select_label: "スタッフ選択",
        login_staff_select_placeholder: "スタッフを選択してください",
        login_password_label: "パスワード",
        login_password_placeholder: "パスワードを入力してください",
        login_button: "ログイン",
        login_forgot_password: "パスワードをお忘れですか？",
        records_title: "記録",
        records_prev_month: "前の月",
        records_next_month: "次の月",
        records_stat_days: "勤務日数",
        records_stat_total: "合計勤務",
        records_stat_avg: "平均",
        records_empty: "記録がありません。",
        records_th_date: "日付",
        records_th_inout: "出/退勤",
        records_th_break: "休憩",
        records_th_work: "勤務",
        records_btn_save: "保存",
        records_btn_cancel: "キャンセル",
        records_aria_edit: "編集",
        today_title: "今日",
        today_desc_default: "今日の勤務時間を記録しましょう。",
        today_desc_editing: "選択した日付を編集中です。",
        today_go_today: "今日へ",
        today_label_check_in: "出勤",
        today_label_check_out: "退勤",
        today_label_break: "休憩時間",
        today_unit_minutes: "単位: 分",
        today_btn_now: "今",
        today_btn_save: "保存",
        today_saved: "保存しました",
        today_data_options: "データオプション",
        today_backup: "バックアップ",
        today_restore: "復元",
        today_clear_all: "全削除",
        today_backup_json: "バックアップ JSON",
        today_restore_json: "復元 JSON",
        today_backup_placeholder: "バックアップを押すとここにJSONが生成されます。",
        today_restore_placeholder: '例: [{"date":"2025-12-19","checkIn":"09:00","checkOut":"18:00","breakMin":60}]',
        today_restore_note: "復元ボタンを押すと上のJSONでデータが上書きされます。",
        today_alert_restore_fail: "復元失敗",
        today_alert_clear_done: "削除しました",
        calendar_title: "カレンダー",
        calendar_prev_month: "前の月",
        calendar_next_month: "次の月",
        calendar_status_none: "記録なし",
        calendar_sheet_edit: "編集する",
        calendar_sheet_close: "閉じる",
        calendar: "カレンダー",
        admin_dashboard_title: "スタッフ勤務状況",
        admin_dashboard_subtitle_today: "今日の状態",
        admin_dashboard_staff_list: "スタッフ一覧",
        admin_monthly_title: "月別",
        admin_monthly_desc: "スタッフ別の月次サマリー",
        admin_monthly_prev_month: "前の月",
        admin_monthly_next_month: "次の月",
        admin_monthly_staff_list: "スタッフ一覧",
        admin_monthly_th_staff: "スタッフ",
        admin_monthly_th_days: "勤務日",
        admin_monthly_th_total: "総勤務",
        admin_monthly_th_incomplete: "未完了",
        admin_monthly_empty_staff: "スタッフがいません。",
        admin_staff_detail_title: "スタッフ詳細",
        admin_staff_detail_prev_month: "前の月",
        admin_staff_detail_next_month: "次の月",
        admin_staff_detail_summary_total_work: "総勤務時間",
        admin_staff_detail_summary_days: "勤務日数",
        admin_staff_detail_summary_incomplete: "未完了",
        admin_staff_detail_empty: "記録がありません。",
        admin_staff_detail_th_date: "日付",
        admin_staff_detail_th_check_in: "出勤",
        admin_staff_detail_th_check_out: "退勤",
        admin_staff_detail_th_break: "休憩",
        admin_staff_detail_th_work: "勤務",
        settings_title: "設定",
        settings_desc: "スタッフ管理とセキュリティ",
        settings_staff_list: "スタッフ一覧",
        settings_add_staff: "スタッフ追加",
        settings_staff_id: "スタッフID",
        settings_staff_name: "スタッフ名",
        settings_staff_password_init: "初期パスワード",
        settings_change_staff_password: "パスワード変更",
        settings_admin_password_change: "管理者パスワード変更",
        settings_admin_password_current: "現在のパスワード",
        settings_admin_password_new: "新しいパスワード",
        settings_admin_password_submit: "変更する",
        settings_alert_password_changed: "パスワードを変更しました",
        settings_error_name_required: "スタッフ名を入力してください",
        settings_error_id_required: "スタッフIDを入力してください",
        settings_error_pw_required: "パスワードを入力してください",
        settings_error_admin_pw_required: "現在のパスワードと新しいパスワードを入力してください",
        settings_error_admin_pw_wrong: "現在のパスワードが正しくありません",
        settings_error_auth_required: "管理者としてログインしてください",
        settings_error_session_expired: "セッションの有効期限が切れました。再ログインしてください。",
        settings_staff_added: "スタッフを追加しました",
        settings_staff_deleted_banned: "勤務記録があるためアカウントは削除されませんが、ログインは無効化されました。",
        settings_staff_pw_changed: "パスワードを変更しました",
        settings_staff_create_failed: "スタッフ作成に失敗しました",
        settings_staff_update_failed: "スタッフ情報の更新に失敗しました",
        settings_staff_limit: "スタッフは最大5人まで追加できます。",
        settings_staff_limit_reached: "スタッフは最大5人まで追加できます。",
        settings_admin_only: "管理者専用",
        settings_delete: "削除",
        settings_confirm_delete_staff: "このスタッフを削除しますか？",
        settings_back: "戻る",
        staff_monthly_title: "月別",
        staff_monthly_total_work: "総勤務時間",
        staff_monthly_total_break: "総休憩時間",
        staff_monthly_days: "勤務日数",
        staff_monthly_incomplete: "未完了",
        staff_monthly_incomplete_hint: "(出/退勤漏れ)",
        staff_monthly_holiday: "総休み",
        staff_monthly_pdf: "PDF出力",
        staff_monthly_warn_title: "記録の確認が必要です",
        staff_monthly_warn_sub: "未完了の勤務記録が {count} 件あります。",
        today_sum_work: "総勤務時間",
        today_sum_break: "休憩時間",
        common_working: "勤務中",
        common_break: "休憩中",
        common_off: "退勤",
        common_no_record: "記録なし",
        common_incomplete: "未完了",
        common_check_in: "出勤",
        common_check_out: "退勤",
        common_break_start: "休憩開始",
        common_holiday: "休み",
        common_holiday_cancel: "休み取消",
        common_save: "保存",
        common_cancel: "キャンセル",
        common_dash: "—",
        common_loading: "読み込み中...",
        common_staff: "スタッフ",
        print_incomplete: "未完了",
        print_holiday: "休み",
        print_holiday_days: "休み",
        print_work: "勤務",
        print_break: "休憩",
        print_overtime: "残業",
        print_early_leave: "早退",
        print_date: "日付",
        print_check_in: "出勤",
        print_check_out: "退勤",
        print_total_work: "総勤務時間",
        print_total_break: "総休憩時間",
        print_workdays: "勤務日数",
        print_title: "出退勤記録表",
        print_monthly_title: "月別記録表",
        print_button: "印刷 / PDF 出力",
        print_no_info: "情報がありません",
        print_invalid_month: "month=YYYY-MM 形式で入力してください",
        print_loading: "Loading...",
        records_filter_all: "全体",
        records_filter_work: "勤務",
        records_filter_incomplete: "未完了",
        records_filter_holiday: "休み",
        records_stat_holiday: "総休み",
      },
    }),
    []
  );

  const setLang = (next: Lang) => {
    setLangState((prev) => {
      const normalized = normalizeLang(next);
      localStorage.setItem(LANG_STORAGE_KEY, normalized);
      if (import.meta.env.DEV && prev !== normalized) console.log(`[i18n] lang changed: ${prev} -> ${normalized}`);
      return normalized;
    });
  };

  const toggleLang = () => setLang(lang === "ko" ? "ja" : "ko");

  const t = (key: LangKey | string) => {
    const table = STRINGS[lang];
    const value = (EXTRA as any)?.[lang]?.[key] ?? (table as any)?.[key];
    if (value !== undefined) return value;
    const fallback = (EXTRA as any)?.ko?.[key] ?? (STRINGS.ko as any)?.[key];
    if (fallback !== undefined) {
      if (import.meta.env.DEV) console.warn(`[i18n] missing key in ${lang}: ${String(key)}, using ko fallback`);
      return fallback;
    }
    if (import.meta.env.DEV) console.warn(`[i18n] missing key: ${String(key)}`);
    return String(key);
  };

  const value = useMemo<I18nValue>(() => ({ lang, setLang, toggleLang, t }), [lang]);

  return <I18nContext.Provider value={value}>{children}</I18nContext.Provider>;
}

export function useI18n() {
  return useContext(I18nContext);
}

export type { Lang, LangKey };
